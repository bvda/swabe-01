<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<title>Lesson 11</title>

	<link rel="stylesheet" href="../../dist/reset.css">
	<link rel="stylesheet" href="../../dist/reveal.css">
	<link rel="stylesheet" href="../../dist/theme/black.css">
	<link rel="stylesheet" type="text/css" href="../../css/asciinema-player.css" />

	<!-- Theme used for syntax highlighted code -->
	<link rel="stylesheet" href="../../plugin/highlight/github-dark.css">
</head>

<body>
	<div class="reveal">
		<div class="slides">
			<section id="introduction">
				<section>
					<h1>Entity Framework Core performance tuning</h1>
					<h3>Lesson 11</h3>
					<h4>SWABE-01</h4>
				</section>
				<section>
					<h2>Agenda</h2>
					<ul>
						<li>Performance optimization</li>
						<li>EF-Core optimization patterns and anti-patterns</li>
						<li></li>
					</ul>
				</section>
			</section>
			<section>
				<section>
					<h2>Performace optimization</h2>
						<ul>
							<li>Kent Beck says
								<ul>
									<li>Make it work</li>
									<li>Make it right</li>
									<li>Make it fast</li>
								</ul>
							</li>
							<li>Consider the software patterns</li>
							<li>Do not write code that makes is hard to fix performace problems</li>
							<li>Pick your architecture with care</li>
						</ul>
				</section>
				<section>
					<h2>Speed and scalability</h2>
					<ul>
						<li><mark>Speed</mark> How much time does it take to handle a request</li>
						<li><mark>Scalability</mark> How many requests can be handled at a time</li>
					</ul>
				</section>
				<section>
					<h2>What to optimize</h2>
					<ul>
						<li>Be selective when deciding what to optimize</li>
						<li>Metrics
							<ul>
								<li>Define the feature what needs to be improved under what circumstances</li>
								<li>Profiling and timing</li>
								<li>Cost of fix</li>
								<li>Verify changes</li>
							</ul>
						</li>
					</ul>
				</section>
				<section>
					<h2>Abstraction</h2>
					<ul>
						<li>Do not be too abstract in your application design
							<ul>
								<li>You can abstract away special features</li>
								<li>Your application will have decreased performance</li>
								<li>You have paid for those features</li>
							</ul>
						</li>
						<li>It will be harder to change the the underlying database
							<ul>
								<li>But how often do you do that?</li>
							</ul>
						</li>
					</ul>
				</section>
			</section>
			<section>
				<section>
					<h2>Fixing performace issues</h2>
				</section>
				<section>
					<h2>SQL inspection</h2>
					<ul>
						<li>The SQL statements are the ultimate truth</li>
						<li>The needed steps to fixing issues
							<ul>
								<li>Understanding the logging output producted by EF Core</li>
								<li>Capturing the logging output</li>
								<li>Extracting the SQL statements sent to the database</li>
							</ul>
						</li>
						<li>EF Core logs temporal measurements</li>
					</ul>
				</section>
				<section>
					<h2>Capturing the logging output</h2>
					<ul>
						<li>Use the built-in logging system in ASP.NET Core
							<ul>
								<li>Logging providers are configures at startup</li>
								<li>EF Core added <code>LogTo</code> in version 5</li>
							</ul>
						</li>
					</ul>
					<pre data-id="code-animation"><code class='cs' data-trim data-line-numbers><script type="text/template">
						var logs = new List<string>();
							var builder =
							new DbContextOptionsBuilder<BookDbContext>()
							.UseSqlServer(connectionString)
							.EnableSensitiveDataLogging()
							.LogTo(log => logs.Add(log), LogLevel.Information);
							using var context = new BookDbContext(builder.Options);
							// TODO: Add real example
					</script></code></pre>
					<small>TODO: Reference</small>
					<aside class="notes" aria-label="notes">
						<h4>References</h4>
						<ul>
							<li><a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/logging">Logging in .NET Core and ASP.NET Core | Microsoft Docs</a></li>
						</ul>
					</aside> 
				</section>
				<section>
					<h2>SQL queries from logging output</h2>
					<pre data-id="code-animation"><code class='sql' data-trim data-line-numbers><script type="text/template">
						Executed DbCommand (4ms)
						[Parameters=[],
						CommandType='Text',
						CommandTimeout='30']
						SELECT [p].[BookId], [p].[Description],
						[p].[ImageUrl], [p].[Price],
						[p].[PublishedOn], [p].[Publisher],
						[p].[Title],
						[p.Promotion].[PriceOfferId],
						[p.Promotion].[BookId],
						[p.Promotion].[NewPrice],
						[p.Promotion].[PromotionalText]
						FROM [Books] AS [p]
						LEFT JOIN [PriceOffers] AS [p.Promotion]
						ON [p].[BookId] = [p.Promotion].[BookId]
						ORDER BY [p].[BookId] DESC
						// TODO: Add real example
					</script></code></pre>
					<small>TODO: Reference</small>
				</section>
			</section>
			<section>
				<section>
					<h2>Good patterns</h2>
				</section>
				<section>
					<h2>Only load the columns you need</h2>
					<aside class="notes" aria-label="notes">
						<h4>References</h4>
						<ul>
							<li>Entity Framework Core in Action, 2nd edition (ISBN 9781617298363) pp. 447-448</li>
						</ul>
					</aside>
				</section>
				<section>
					<h2>Paging and filtering</h2>
					<aside class="notes" aria-label="notes">
						<h4>References</h4>
						<ul>
							<li>Entity Framework Core in Action, 2nd edition (ISBN 9781617298363) p. 448</li>
						</ul>
					</aside>
				</section>
				<section>
					<h2>Add <code>AsNoTracking()</code> to read-only queries</h2>
					<aside class="notes" aria-label="notes">
						<h4>References</h4>
						<ul>
							<li>Entity Framework Core in Action, 2nd edition (ISBN 9781617298363) p. 449</li>
						</ul>
					</aside>
				</section>
				<section>
					<h2>Use Async versions of EF Core commands</h2>
					<aside class="notes" aria-label="notes">
						<h4>References</h4>
						<ul>
							<li>Entity Framework Core in Action, 2nd edition (ISBN 9781617298363) p. 449</li>
						</ul>
					</aside>
				</section>
				<section>
					<h2>Decouple database access code</h2>
					<ul>
						<li>Prepares the code base for performance optimization</li>
					</ul>
					<aside class="notes" aria-label="notes">
						<h4>References</h4>
						<ul>
							<li>Entity Framework Core in Action, 2nd edition (ISBN 9781617298363) p. 449</li>
						</ul>
					</aside>
				</section>
			</section>
			<section>
				<section>
					<h3>Anti-patterns</h3>
					<h2>Queries</h2>
				</section>
				<section>
					<h2>Not minimizing calls to databases</h2>
					<aside class="notes" aria-label="notes">
						<h4>References</h4>
						<ul>
							<li>Entity Framework Core in Action, 2nd edition (ISBN 9781617298363) pp. 450-451</li>
						</ul>
					</aside>
				</section>
				<section>
					<h2>Missing indexes</h2>
					<aside class="notes" aria-label="notes">
						<h4>References</h4>
						<ul>
							<li>Entity Framework Core in Action, 2nd edition (ISBN 9781617298363) pp. 451-452</li>
						</ul>
					</aside>
				</section>
				<section>
					<h2>Loading single entities</h2>
					<aside class="notes" aria-label="notes">
						<h4>References</h4>
						<ul>
							<li>Entity Framework Core in Action, 2nd edition (ISBN 9781617298363) p. 452</li>
						</ul>
					</aside>
				</section>
				<section>
					<h2>Data query in software</h2>
					<aside class="notes" aria-label="notes">
						<h4>References</h4>
						<ul>
							<li>Entity Framework Core in Action, 2nd edition (ISBN 9781617298363) p. 453</li>
						</ul>
					</aside>
				</section>
				<section>
					<h2>Not doing calculations into the database</h2>
					<aside class="notes" aria-label="notes">
						<h4>References</h4>
						<ul>
							<li>Entity Framework Core in Action, 2nd edition (ISBN 9781617298363) pp. 453-454</li>
						</ul>
					</aside>
				</section>
			</section>
			<section>
				<section>
					<h3>Anti-patterns</h3>
					<h2>Writes</h2>
				</section>
				<section>
					<h2>Calling <code>SaveChanges()</code> multiple times</h2>
					<aside class="notes" aria-label="notes">
						<h4>References</h4>
						<ul>
							<li>Entity Framework Core in Action, 2nd edition (ISBN 9781617298363) p. 456</li>
						</ul>
					</aside>
				</section>
				<section>
					<h2>Making <code>DetectChanges()</code> work too hard</h2>
					<aside class="notes" aria-label="notes">
						<h4>References</h4>
						<ul>
							<li>Entity Framework Core in Action, 2nd edition (ISBN 9781617298363) p. 457</li>
						</ul>
					</aside>
				</section>
				<section>
					<h2>Updating entities</h2>
				</section>
				<section>
					<h2>Using one large <code>DbContext</code></h2>
					<aside class="notes" aria-label="notes">
						<h4>References</h4>
						<ul>
							<li>Entity Framework Core in Action, 2nd edition (ISBN 9781617298363) p. 458</li>
						</ul>
					</aside>
				</section>
			</section>
			<section>
				<section>
					<h2>Wrap-up</h2>
					<ul>
						<li></li>
						<li></li>
						<li></li>
					</ul>
				</section>
			</section>
		</div>
	</div>

	<script src="../../dist/reveal.js"></script>
	<script src="../../plugin/notes/notes.js"></script>
	<script src="../../plugin/markdown/markdown.js"></script>
	<script src="../../plugin/highlight/highlight.js"></script>
	<script src="../../js/asciinema-player.js"></script>

	<script>
		// More info about initialization & config:
		// - https://revealjs.com/initialization/
		// - https://revealjs.com/config/
		Reveal.initialize({
			hash: true,
			slideNumber: true,
			pdfSeparateFragments: false,
			// Learn about plugins: https://revealjs.com/plugins/
			plugins: [RevealMarkdown, RevealHighlight, RevealNotes]
		});
	</script>
</body>

</html>